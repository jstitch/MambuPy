stages:
  - "lint"
  - "UnitTests"
  - "quality"
  - "deploys"

Linter:
  stage: lint
  image: "python:3"
  script:
    - pip install -q --no-cache-dir pylint
    - find ./MambuPy -iname "*.py" | xargs pylint --disable=all --enable=trailing-whitespace,trailing-newlines,missing-final-newline --output-format=parseable
    - find ./tests -iname "*.py" | xargs pylint --disable=all --enable=trailing-whitespace,trailing-newlines,missing-final-newline --output-format=parseable

.UnitTests:
  artifacts:
    paths:
      - htmlcov_${CI_PROJECT_NAME}_$PYVERSION.tar.bz2
      - coverage_${CI_PROJECT_NAME}_$PYVERSION.xml
    expire_in: 1 day
  before_script:
    - pip install -q --no-cache-dir --upgrade -r requirements.txt

UnitTests-3:
  extends: ".UnitTests"
  stage: "UnitTests"
  variables:
    PYVERSION: "3"
  image: "python:3"
  script:
    - rm -f .coverage
    - rm -rf htmlcov
    - rm -f coverage.xml
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambustruct.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambuconfig.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambuutil.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambutask.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mamburoles.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambuuser.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambuloan.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambuactivity.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambubranch.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambucentre.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambuclient.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mamburepayment.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambutransaction.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambugroup.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambuproduct.py

    - coverage run --append --rcfile=./.coveragerc tests/api/unit_mambuconnector.py
    - coverage run --append --rcfile=./.coveragerc tests/api/unit_mambustruct.py
    - coverage run --append --rcfile=./.coveragerc tests/api/unit_mambuloan.py

    - coverage html
    - mv htmlcov htmlcov_${CI_PROJECT_NAME}_$PYVERSION
    - tar cjf htmlcov_${CI_PROJECT_NAME}_$PYVERSION.tar.bz2 htmlcov_${CI_PROJECT_NAME}_$PYVERSION
    - coverage xml
    - mv coverage.xml coverage_${CI_PROJECT_NAME}_$PYVERSION.xml
    - coverage report --precision=2

UnitTests-2:
  extends: ".UnitTests"
  stage: "UnitTests"
  variables:
    PYVERSION: "2"
  image: "python:2"
  script:
    - rm -f .coverage
    - rm -rf htmlcov
    - rm -f coverage.xml
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambustruct.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambuconfig.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambuutil.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambutask.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mamburoles.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambuuser.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambuloan.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambuactivity.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambubranch.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambucentre.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambuclient.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mamburepayment.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambutransaction.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambugroup.py
    - coverage run --append --rcfile=./.coveragerc tests/unit_mambuproduct.py

    - coverage report --precision=2


# gitlab users forking this project: you should create a group named
# mambupy with a project named mambupy, with a file named
# .gitlab-ci_deploy.yml

# without this, your pipelines will fail

# there you can put your own deploy rules, or if you don't have any,
# you can add a job for some of the "quality" or "deploys" stages
# doing an echo to console

include:
  - project: 'mambupy/mambupy-deploy'
    file: '.gitlab-ci_deploy.yml'
